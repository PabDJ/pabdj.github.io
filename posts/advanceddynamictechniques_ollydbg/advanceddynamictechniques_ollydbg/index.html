<!doctype html><html><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><title>Advanced Dynamic Techniques - OllyDbg - Pablo de Juan Fidalgo</title><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Table of Contents Notes Memory map Breakpoints Loading DLLs Labs Lab 1 Lab 2 Lab 3 Notes Memory map All PE files in Windows have a preferred base address, known as the image base defined in the PE header. The image base isn’t necessarily the address where the malware will be loaded, although it usually is. Most executables are designed to be loaded at 0x00400000, which is just the default address used by many compilers for the Windows platform."><meta property="og:image" content><meta property="og:title" content="Advanced Dynamic Techniques - OllyDbg"><meta property="og:description" content="Table of Contents Notes Memory map Breakpoints Loading DLLs Labs Lab 1 Lab 2 Lab 3 Notes Memory map All PE files in Windows have a preferred base address, known as the image base defined in the PE header. The image base isn’t necessarily the address where the malware will be loaded, although it usually is. Most executables are designed to be loaded at 0x00400000, which is just the default address used by many compilers for the Windows platform."><meta property="og:type" content="article"><meta property="og:url" content="https://pabdj.github.io/posts/advanceddynamictechniques_ollydbg/advanceddynamictechniques_ollydbg/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-01-11T15:20:58+05:30"><meta property="article:modified_time" content="2023-01-11T15:20:58+05:30"><meta name=twitter:card content="summary"><meta name=twitter:title content="Advanced Dynamic Techniques - OllyDbg"><meta name=twitter:description content="Table of Contents Notes Memory map Breakpoints Loading DLLs Labs Lab 1 Lab 2 Lab 3 Notes Memory map All PE files in Windows have a preferred base address, known as the image base defined in the PE header. The image base isn’t necessarily the address where the malware will be loaded, although it usually is. Most executables are designed to be loaded at 0x00400000, which is just the default address used by many compilers for the Windows platform."><script src=https://pabdj.github.io/js/feather.min.js></script>
<link href=https://pabdj.github.io/css/fonts.2c2227b81b1970a03e760aa2e6121cd01f87c88586803cbb282aa224720a765f.css rel=stylesheet><link rel=stylesheet type=text/css media=screen href=https://pabdj.github.io/css/main.0fd5f05032e8d6d12808eb2d48a5a295f4ee5cd8eefd5bf3dbfd49a346d206ed.css><link id=darkModeStyle rel=stylesheet type=text/css href=https://pabdj.github.io/css/dark.73617b6be66d271725422ddf83ec3f8c57af298005233c552735d43adf634f04.css disabled></head><body><div class=content><header><div class=main><a href=https://pabdj.github.io/>Pablo de Juan Fidalgo</a></div><nav><a href=/>Home</a>
<a href=/posts>Blog</a>
<a href=/tags>Tags</a>
| <a id=dark-mode-toggle onclick=toggleTheme() href></a>
<script src=https://pabdj.github.io/js/themetoggle.js></script></nav></header><main><article><div class=title><h1 class=title>Advanced Dynamic Techniques - OllyDbg</h1><div class=meta>Posted on Jan 11, 2023</div></div><section class=body><h2 id=table-of-contents>Table of Contents</h2><ol><li><a href=#notes>Notes</a><ol><li><a href=#memory-map>Memory map</a></li><li><a href=#breakpoints>Breakpoints</a></li><li><a href=#loading-dlls>Loading DLLs</a></li></ol></li><li><a href=#labs>Labs</a><ol><li><a href=#lab-1>Lab 1</a></li><li><a href=#lab-2>Lab 2</a></li><li><a href=#lab-3>Lab 3</a></li></ol></li></ol><h2 id=notes>Notes</h2><h3 id=memory-map>Memory map</h3><p>All PE files in Windows have a preferred base address, known as the image base defined in the PE header.
The image base isn’t necessarily the address where the malware will be loaded, although it usually is. Most executables are designed to be loaded at 0x00400000, which is just the default address used by many compilers for the Windows platform. Developers can choose to base executables at different addresses. Executables that support address space layout randomization (ASLR) security enhancement will often be relocated. That said, relocation of DLLs is much more common.</p><h3 id=breakpoints>Breakpoints</h3><p>Hardware breakpoints are useful to protect against certain anti-debugging techniques, such as
software breakpoint scanning.</p><p>Memory breakpoints are particularly useful during malware analysis when you want to find out when a loaded DLL is used: you can use a memory breakpoint to pause execution as soon as code in the DLL is executed.</p><h3 id=loading-dlls>Loading DLLs</h3><p>By default, OllyDbg breaks at the DLL entry point (DllMain) once the DLL is loaded. Next, OllyDbg will pause, and you can call specific exports with arguments and debug them by selecting <code>Debug➡️Call DLL Export</code> from the main menu. In order to call exported functions with arguments inside the debugged DLL, you first need to load the DLL with OllyDbg. Then, once it pauses at the
DLL entry point, click the play button to run DllMain and any other initialization the DLL requires.</p><h2 id=labs>Labs</h2><h3 id=lab-1>Lab 1</h3><p><strong>1. How can you get this malware to install itself?</strong></p><p>To begin the analysis we check the imports of the file. There are some of them that stand out like <em>CreateFile</em>, <em>ReadFile</em>, <em>WriteFile</em>, <em>DeleteFile</em>, <em>RegSetValue</em>, <em>RegCreateKey</em>, <em>CreateService</em>, <em>ShellExecute</em> or <em>CreateProcess</em> among others.<figure><img src=../9-1.PNG></figure></p><p>Main is located at address 0x402AF0 and contains several commands such as <em>-in</em>, <em>-re</em>, <em>-c</em> and <em>-cc</em>.</p><table><thead><tr><th style=text-align:center>Entrypoint</th><th style=text-align:center>Main</th></tr></thead><tbody><tr><td style=text-align:center><figure><img src=../9-1-1.PNG></figure></td><td style=text-align:center>!<figure><img src=../9-1-2.PNG></figure></td></tr></tbody></table><p>Anyway, if we do not provide any, the malware calls a function located at 0x402B2E that checks some characters from argv buffer. It might be a password. After that, it tries to delete itself.<figure><img src=../9-1-3.PNG></figure><figure><img src=../9-1-6.PNG></figure><figure><img src=../9-1-4.PNG></figure></p><p><em>-in</em> command seems to work as an installer but if we provide it as a unique argument at OllyDbg it still does not work. In fact, it checks the existence of the registry key &ldquo;<em>SOFTWARE/Microsoft /XPS</em>&rdquo; and if the call is not successful it tries to delete itself again.</p><p>The beginning of the program can be summarized with the following screenshot:<figure><img src=../9-1-5.PNG></figure></p><p>We have different ways in order to run the malware. The first approach could be to patch the result of the call that checks the registry key but this could lead to more problems in the future, so it would be better to patch the <em>CheckPassword</em> function or even provide the password as we already know from the screenshots above that it is &ldquo;<em>abcd</em>&rdquo;.</p><h4 id=patching-checkpassword-function>Patching <em>CheckPassword</em> function</h4><p>The password is located at 0x402B2E. If the password is correct, the function return 1 at EAX, otherwise EAX has value 0. In my opinion, this is the most straight forward way to patch the binary.<figure><img src=../9-1-7.png></figure></p><h4 id=providing-arguments-to-the-binary>Providing arguments to the binary</h4><p>We have to click Debug➡️Arguments and set: &ldquo;-in abcd&rdquo;. This will allow us to run the binary without any problem.</p><p><strong>2. What are the command-line options for this program? What is the password requirement?</strong></p><p>There are several commands such as <em>-in</em>, <em>-re</em>, <em>-c</em> and <em>-cc</em>.</p><ul><li><strong><em>-in</em> command</strong>: creates a service and calls the function that achieves persistence by creating registry key.</li><li><strong>-<em>re</em> command</strong>: closes the service and removes the malware.</li><li><strong>-<em>c</em> command</strong>: updates its configuration.</li><li><strong>-<em>cc</em> command</strong>: prints the current configuration.</li></ul><p>The password requirement can be bypassed, although it can be easily guessed as it looks for the string &ldquo;<em>abcd</em>&rdquo;.</p><p><strong>3. How can you use OllyDbg to permanently patch this malware, so that it doesn’t require the special command-line password?</strong></p><p>Instead of modifying the EAX registry each time we reach the <em>CheckPassword</em> function, we can do the following:</p><p><code>We assemble these instructions using the Assemble option in OllyDbg and get the 6-byte sequence: B8 01 00 00 00 C3. Because the CALL instruction prepares the stack, and the RET instruction cleans it up, we can overwrite the instructions at the very beginning of the password check function, at address 0x402510. Edit the instructions by right-clicking the start address you wish to edit and selecting Binary➡️Edit. We uncheck the box labeled Keep size. We then enter the assembled hex values in the HEX+06 field and click OK. Select Copy to executable➡️All modifications. Accept all dialogs, and save the new version as Lab09-01-patched.exe.</code></p><p><strong>4. What are the host-based indicators of this malware?</strong></p><p>The registry key &ldquo;<em>SOFTWARE/Microsoft /XPS</em>&rdquo;.</p><p><strong>5. What are the different actions this malware can be instructed to take via the network?</strong></p><p>The function located at 0x402020, renamed as <em>getcommands</em>, implements functionality under several commands such as <em>SLEEP</em>, <em>UPLOAD</em>, <em>DOWNLOAD</em>, <em>CMD</em> and <em>NOTHING</em>.</p><p>Sleep command as it may be obvious, sleeps for a number of seconds.
Upload (0x4019E0) connects to a socket and writes the content that has been read into a file.<figure><img src=../9-1-8.PNG></figure></p><p>Download (0x401870) sends the content of the file over a socket.<figure><img src=../9-1-9.PNG></figure></p><p>CMD that executes the shell command with cmd.exe and sends the output to the remote host.</p><p>Nothing which does nothing.</p><p><strong>6. Are there any useful network-based signatures for this malware?</strong></p><p>This question was particularly hard because although it was easy to find network-related strings such as the ones in the screenshot below, I was not able to retrieve the behaviour under it.
It is obvious that a GET request is sent under HTTP 1.0 but the messages that played with apostrophes and backticks were totally random for me. They are in fact precise messages under the C2 protocol of the malware.<figure><img src=../9-1-10.PNG></figure></p><h3 id=lab-2>Lab 2</h3><p><strong>1. What strings do you see statically in the binary?</strong></p><p>We can observe the imports and some interesting strings like &ldquo;<em>www[.]practicalmalwareanalysis[.]com</em>&rdquo; and &ldquo;<em>ocl.exe</em>&rdquo;.<figure><img src=../9-2.PNG></figure></p><p><strong>2. What happens when you run this binary?</strong></p><p>It does not show much activity.</p><p><strong>3. How can you get this sample to run its malicious payload?</strong></p><p>It checks if the sample is named as &ldquo;<em>ocl.exe</em>&rdquo;. We can rename the file or patch the value at EAX after calling strcmp.</p><table><thead><tr><th style=text-align:center>Ghidra</th><th style=text-align:center>OllyDbg</th></tr></thead><tbody><tr><td style=text-align:center><figure><img src=../9-2-3.PNG></figure></td><td style=text-align:center><figure><img src=../9-2-4.PNG></figure></td></tr></tbody></table><p><strong>4. What is happening at 0x00401133?</strong></p><p>The string is divided character by character into memory in order to obfuscate it.</p><p><strong>5. What arguments are being passed to subroutine 0x00401089?</strong></p><p>The string <em>1qaz2wsx3edc</em> and a pointer to an array.<figure><img src=../9-2-5.PNG></figure></p><p><strong>6. What domain name does this malware use?</strong></p><p>The domain is &ldquo;<em>www[.]practicalmalwareanalysis[.]com</em>&rdquo;. Fortunately <a href=https://github.com/mandiant/flare-floss>FLOSS</a> was able to decode it without any effort.<figure><img src=../9-2-6.PNG></figure></p><p><strong>7. What encoding routine is being used to obfuscate the domain name?</strong></p><p>The domain name is XORed with the string <em>1qaz2wsx3edc</em>.</p><p><strong>8. What is the significance of the CreateProcessA call at 0x0040106E?</strong></p><p>Function <em>main</em> calls subroutine at 0x401000 which calls CreateProcess function.</p><p>If <em>connect</em> call fails, subroutine at 0x401000 is called which creates a command line process which is binded with the socket descriptor to provide a reverse shell.</p><table><thead><tr><th style=text-align:center>Main</th><th style=text-align:center>Subroutine 0x401000</th></tr></thead><tbody><tr><td style=text-align:center><figure><img src=../9-2-1.PNG></figure></td><td style=text-align:center><figure><img src=../9-2-2.PNG></figure></td></tr></tbody></table><h3 id=lab-3>Lab 3</h3><p><strong>1. What DLLs are imported by Lab09-03.exe?</strong></p><p>The DLLs imported are KERNEL32.dll, NETAPI32.dll, DLL1.dll and DLL2.dll
With FLOSS we can observe that user32.dll and DLL3.dll are also imported.<figure><img src=../9-3.PNG></figure><figure><img src=../9-3-1.PNG></figure></p><p><strong>2. What is the base address requested by DLL1.dll, DLL2.dll, and DLL3.dll?</strong></p><p>The three DLLs requested the same address (0x1000000).</p><table><thead><tr><th style=text-align:center>DLL1.dll</th><th style=text-align:center>DLL2.dll</th><th style=text-align:center>DLL3.dll</th></tr></thead><tbody><tr><td style=text-align:center><figure><img src=../9-3-2.PNG></figure></td><td style=text-align:center><figure><img src=../9-3-3.PNG></figure></td><td style=text-align:center><figure><img src=../9-3-4.PNG></figure></td></tr></tbody></table><p><strong>3. When you use OllyDbg to debug Lab09-03.exe, what is the assigned based address for: DLL1.dll, DLL2.dll, and DLL3.dll?</strong></p><p>We know from before that DLL3 is loaded dynamically, so we have to run the code until <em>LoadLibrary</em> is called with DLL3 as a parameter.<figure><img src=../9-3-5.PNG></figure></p><p>Once it has been loaded, we click <code>View ➡️ Memory</code> and observe that DLL2 and DLL3 have been relocated. In the following picture we can see where they have been loaded.<figure><img src=../9-3-6.PNG></figure>DLL2 is loaded at 0x30000 and DLL3 at 0x220000.</p><p><strong>4. When Lab09-03.exe calls an import function from DLL1.dll, what does this import function do?</strong></p><p>At address 0x401006, <em>DLL1Print</em> is called. The output that is printed at the command window after running that function is:<figure><img src=../9-3-7.PNG></figure></p><p><strong>5. When Lab09-03.exe calls WriteFile, what is the filename it writes to?</strong></p><p>As we can observe, <em>WriteFile</em> receives as a parameter a file handler, which is the return of the <em>DLL2ReturnJ</em> function. The next step is to analyze DLL2 file to gather more information about it.<figure><img src=../9-3-8.PNG></figure></p><p>This is what <em>DLL2ReturnJ</em> function does:<figure><img src=../9-3-9.PNG></figure></p><p>As this does not provide much information, the first thing that comes to my mind is to look for cross-references to that return value, which are listed below.<figure><img src=../9-3-10.PNG></figure></p><p>The last one is the one that we have already seen, so we need to check the other two references.
And <em>voilà</em>! The filename is <em>temp.txt</em>.<figure><img src=../9-3-11.PNG></figure></p><p><strong>6. When Lab09-03.exe creates a job using NetScheduleJobAdd, where does it get the data for the second parameter?</strong></p><p><em>NetScheduleJobAdd</em> function receives three parameters. The second one refers to a buffer.
Line 24 shows that the buffer is heavily linked to the <a href=https://learn.microsoft.com/en-us/windows/win32/api/libloaderapi/nf-libloaderapi-getprocaddress><em>GetProcAddress</em></a> function, that retrieves the address of an exported function from the specified DLL, in this case DLL3.<figure><img src=../9-3-12.PNG></figure></p><p><strong>7. While running or debugging the program, you will see that it prints out three pieces of mystery data. What are the following: DLL 1 mystery data 1, DLL 2 mystery data 2, and DLL 3 mystery data 3?</strong></p><p>DLL 1 mystery data corresponds to the PID of the program:<figure><img src=../9-3-14.PNG></figure><figure><img src=../9-3-15.PNG></figure></p><p>We can also check this value by debugging the program and inspecting it with Process Explorer.<figure><img src=../9-3-13.PNG></figure></p><p>DLL 2 mystery data corresponds to the handle of <em>temp.txt</em> file.</p><table><thead><tr><th style=text-align:center>DLL2Print function</th><th style=text-align:center>Return of CreateFile that is printed out</th></tr></thead><tbody><tr><td style=text-align:center><figure><img src=../9-3-16.PNG></figure></td><td style=text-align:center><figure><img src=../9-3-17.PNG></figure></td></tr></tbody></table><p>Finally, DLL 3 mistery data corresponds to the ping to &ldquo;<em>www[.]malwareanalysis[.]com</em>&rdquo; in memory.<figure><img src=../9-3-18.PNG></figure><figure><img src=../9-3-19.PNG></figure></p><p><strong>8. How can you load DLL2.dll into IDA Pro so that it matches the load address used by OllyDbg?</strong></p><p>We have to select Manual Load when loading the DLL with IDA Pro, and then type the new image base address (0x30000).</p></section><div class=post-tags><nav class="nav tags"><h2 class=title>Tags</h2><ul class=tags><li><a href=/tags/practical-malware-analysis>practical malware analysis</a></li><li><a href=/tags/malware>malware</a></li><li><a href=/tags/reversing>reversing</a></li><li><a href=/tags/advanced>advanced</a></li><li><a href=/tags/dynamic>dynamic</a></li><li><a href=/tags/analysis>analysis</a></li><li><a href=/tags/x86>x86</a></li><li><a href=/tags/x64>x64</a></li><li><a href=/tags/assembly>assembly</a></li><li><a href=/tags/registers>registers</a></li><li><a href=/tags/ollydbg>ollydbg</a></li><li><a href=/tags/ghidra>ghidra</a></li></ul></nav></div></article></main><footer><div style=display:flex><a class=soc href=https://github.com/pabdj title=GitHub><i data-feather=github></i></a>
<a class=border></a><a class=soc href=https://twitter.com/pabdjf title=Twitter><i data-feather=twitter></i></a>
<a class=border></a><a class=soc href=https://es.linkedin.com/in/pablodejuanfidalgo title=LinkedIn><i data-feather=linkedin></i></a>
<a class=border></a></div><div class=footer-info>2023 © Pablo de Juan Fidalgo |</div></footer><script>feather.replace()</script></div></body></html>
<!doctype html><html><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><title>Malware Functionality - Malware Behaviour - Pablo de Juan Fidalgo</title><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Table of Contents Notes Downloaders and Launchers Backdoors Reverse shell RATs Botnets Credential Stealers GINA Interception Hash Dumping Keystroke Logging Persistence Mechanisms Windows Registry AppInit_DLLs Winlogon Notify SvcHost DLLs Trojanized System Binaries DLL Load-Order Hijacking Privilege Escalation Covering Its Tracksâ€”User-Mode Rootkits IAT Hooking Inline Hooking Labs Lab 1 Lab 2 Lab 3 Notes Downloaders and Launchers Downloaders simply download another piece of malware from the Internet and execute it on the local system."><meta property="og:image" content><meta property="og:title" content="Malware Functionality - Malware Behaviour"><meta property="og:description" content="Table of Contents Notes Downloaders and Launchers Backdoors Reverse shell RATs Botnets Credential Stealers GINA Interception Hash Dumping Keystroke Logging Persistence Mechanisms Windows Registry AppInit_DLLs Winlogon Notify SvcHost DLLs Trojanized System Binaries DLL Load-Order Hijacking Privilege Escalation Covering Its Tracksâ€”User-Mode Rootkits IAT Hooking Inline Hooking Labs Lab 1 Lab 2 Lab 3 Notes Downloaders and Launchers Downloaders simply download another piece of malware from the Internet and execute it on the local system."><meta property="og:type" content="article"><meta property="og:url" content="https://pabdj.github.io/posts/malwarefunctionality_malware_behaviour/malware-behaviour/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-03-27T22:53:58+05:30"><meta property="article:modified_time" content="2023-03-27T22:53:58+05:30"><meta name=twitter:card content="summary"><meta name=twitter:title content="Malware Functionality - Malware Behaviour"><meta name=twitter:description content="Table of Contents Notes Downloaders and Launchers Backdoors Reverse shell RATs Botnets Credential Stealers GINA Interception Hash Dumping Keystroke Logging Persistence Mechanisms Windows Registry AppInit_DLLs Winlogon Notify SvcHost DLLs Trojanized System Binaries DLL Load-Order Hijacking Privilege Escalation Covering Its Tracksâ€”User-Mode Rootkits IAT Hooking Inline Hooking Labs Lab 1 Lab 2 Lab 3 Notes Downloaders and Launchers Downloaders simply download another piece of malware from the Internet and execute it on the local system."><script src=https://pabdj.github.io/js/feather.min.js></script>
<link href=https://pabdj.github.io/css/fonts.2c2227b81b1970a03e760aa2e6121cd01f87c88586803cbb282aa224720a765f.css rel=stylesheet><link rel=stylesheet type=text/css media=screen href=https://pabdj.github.io/css/main.0fd5f05032e8d6d12808eb2d48a5a295f4ee5cd8eefd5bf3dbfd49a346d206ed.css><link id=darkModeStyle rel=stylesheet type=text/css href=https://pabdj.github.io/css/dark.73617b6be66d271725422ddf83ec3f8c57af298005233c552735d43adf634f04.css disabled></head><body><div class=content><header><div class=main><a href=https://pabdj.github.io/>Pablo de Juan Fidalgo</a></div><nav><a href=/>Home</a>
<a href=/posts>Blog</a>
<a href=/tags>Tags</a>
| <a id=dark-mode-toggle onclick=toggleTheme() href></a>
<script src=https://pabdj.github.io/js/themetoggle.js></script></nav></header><main><article><div class=title><h1 class=title>Malware Functionality - Malware Behaviour</h1><div class=meta>Posted on Mar 27, 2023</div></div><section class=body><h2 id=table-of-contents>Table of Contents</h2><ol><li><a href=#notes>Notes</a><ol><li><a href=#downloaders-and-launchers>Downloaders and Launchers</a></li><li><a href=#backdoors>Backdoors</a><ol><li><a href=#reverse-shell>Reverse shell</a></li><li><a href=#rats>RATs</a></li><li><a href=#botnets>Botnets</a></li></ol></li><li><a href=#credential-stealers>Credential Stealers</a><ol><li><a href=#gina-interception>GINA Interception</a></li><li><a href=#hash-dumping>Hash Dumping</a></li><li><a href=#keystroke-logging>Keystroke Logging</a></li></ol></li><li><a href=#persistence-mechanisms>Persistence Mechanisms</a><ol><li><a href=#windows-registry>Windows Registry</a><ol><li><a href=#appinit_dlls>AppInit_DLLs</a></li><li><a href=#winlogon-notify>Winlogon Notify</a></li><li><a href=#svchost-dlls>SvcHost DLLs</a></li></ol></li><li><a href=#trojanized-system-binaries>Trojanized System Binaries</a></li><li><a href=#dll-load-order-hijacking>DLL Load-Order Hijacking</a></li></ol></li><li><a href=#privilege-escalation>Privilege Escalation</a></li><li><a href=#covering-its-tracksuser-mode-rootkits>Covering Its Tracksâ€”User-Mode Rootkits</a><ol><li><a href=#iat-hooking>IAT Hooking</a></li><li><a href=#inline-hooking>Inline Hooking</a></li></ol></li></ol></li><li><a href=#labs>Labs</a><ol><li><a href=#lab-1>Lab 1</a></li><li><a href=#lab-2>Lab 2</a></li><li><a href=#lab-3>Lab 3</a></li></ol></li></ol><h2 id=notes>Notes</h2><h3 id=downloaders-and-launchers>Downloaders and Launchers</h3><p>Downloaders simply download another piece of malware from the Internet and execute it on the local system. They commonly use the Windows API <em>URLDownloadtoFileA</em>, followed by a call to <em>WinExec</em> to download and execute new malware.</p><p>A launcher (also known as a loader) is any executable that installs malware for immediate or future covert execution. Launchers often contain the malware that they are designed to load.</p><h3 id=backdoors>Backdoors</h3><p>A <em>backdoor</em> is a type of malware that provides an attacker with remote access to a victimâ€™s machine. Backdoors are the most commonly found type of malware, and they often implement a full set of capabilities, that&rsquo;s why attackers typically donâ€™t need to download additional malware.</p><h4 id=reverse-shell>Reverse shell</h4><p>The basic method involves a call to <em>CreateProcess</em> and the manipulation of the <em>STARTUPINFO</em> structure that is passed to <em>CreateProcess</em>. Once the socket is created and a connection is established, the socket is then tied to the standard streams (standard input, standard output, and standard error) for cmd.exe. <em>CreateProcess</em> obviously runs cmd.exe with its window suppressed.</p><p>The multithreaded version of a Windows reverse shell involves the creation of a socket, two pipes, and two threads (so look for API calls to <em>CreateThread</em> and <em>CreatePipe</em>). <em>CreatePipe</em> can be used to tie together read and write ends to a pipe. The <em>CreateProcess</em> method can be used to tie the standard streams to pipes instead of directly to the sockets. After <em>CreateProcess</em> is called, the
malware will spawn two threads: one for reading from the stdin pipe and writing to the socket, and the other for reading the socket and writing to the stdout pipe.</p><h4 id=rats>RATs</h4><p>A remote administration tool (RAT) is used to remotely manage a computer or computers. RATs are often used in targeted attacks with specific goals, such as stealing information or moving laterally across a network. The structure is the following: the server is running on a victim host implanted with malware and the client is running remotely as the command and control unit operated by the attacker.</p><h4 id=botnets>Botnets</h4><p>A botnet is a collection of compromised hosts, known as zombies, that are controlled by a single entity, usually through the use of a server known as a botnet controller. The goal of a botnet is to compromise as many hosts as possible in order to create a large network of zombies that the botnet uses to spread additional malware or spam, or perform a distributed denial-of-service (DDoS) attack.</p><p>ðŸ’¡ RATs are used in targeted attacks (they are controlled on a per-victim basis). Botnets are used in mass attacks (all bots at once).</p><h3 id=credential-stealers>Credential Stealers</h3><h4 id=gina-interception>GINA Interception</h4><p>On Windows XP, Microsoftâ€™s <em>Graphical Identification and Authentication</em> (GINA) interception is a technique that malware uses to steal user credentials. The GINA system was intended to allow legitimate third parties to customize the logon process. Malware authors take advantage of this third-party support to load their credential stealers with a Man-in-the-middle (MiTM) attack.</p><h4 id=hash-dumping>Hash Dumping</h4><p>Dumping Windows hashes is a popular way for malware to access system credentials. Attackers try to grab these hashes in order to crack them offline or to use them in a pass-the-hash attack. A pass-the-hash attack uses LM and NTLM hashes to authenticate to a remote host (using NTLM authentication) without needing to decrypt or crack the hashes to obtain the plaintext password to log in.</p><p>Pwdump and the Pass-the-Hash (PSH) Toolkit are freely available packages that provide hash dumping.</p><h4 id=keystroke-logging>Keystroke Logging</h4><p>There are kernel-based keyloggers and user-based keyloggers. The former are obviously more difficult to detect. They can be in the form of keyboard drivers inside a rootkit.
User-based keyloggers are divided in those that implement <strong>hooking</strong> and those that use <strong>polling</strong>.
Hooking keyloggers:</p><ul><li>They typically use the <em>SetWindowsHookEx</em> function.</li></ul><p>Polling keyloggers:</p><ul><li>They typically use the <em>GetAsyncKeyState</em> and <em>GetForegroundWindow</em> functions.</li><li>The <em>GetAsyncKeyState</em> function identifies whether a key is pressed or depressed, and whether the key was pressed after the most recent call to <em>GetAsyncKeyState</em>. The <em>GetForegroundWindow</em> function identifies the foreground windowâ€”the one that has focusâ€”which tells the keylogger which application is being used for keyboard entry.</li></ul><h3 id=persistence-mechanisms>Persistence Mechanisms</h3><h4 id=windows-registry>Windows Registry</h4><h5 id=appinit_dlls>AppInit_DLLs</h5><p>Malware authors can gain persistence for their DLLs though a special registry location called <code>AppInit_DLL</code>. AppInit_DLLs are loaded into every process that loads <em>User32.dll</em>, and a simple insertion into the registry will make AppInit_DLLs persistent.
The Windows Registry key involved in this type of achieving persistence is:
<code>HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Windows</code></p><h5 id=winlogon-notify>Winlogon Notify</h5><p>Malware authors can hook malware to a particular Winlogon event, such as logon, logoff, startup, shutdown, and lock screen. The registry entry consists of the Notify value in the following registry key: <code>HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon\</code></p><h5 id=svchost-dlls>SvcHost DLLs</h5><p>To identify this technique, monitor the Windows registry using dynamic analysis, or look for service functions such as <em>CreateServiceA</em> in the disassembly. If malware is modifying the following registry keys, youâ€™ll know that itâ€™s using this persistence technique.
<code>HKEY_LOCAL_MACHINE\System\CurrentControlSet\Services\ServiceName</code></p><p>All <em>svchost.exe</em> DLLs contain a <code>Parameters</code> key with a <code>ServiceDLL</code> value, which the malware author sets to the location of the malicious DLL.</p><h4 id=trojanized-system-binaries>Trojanized System Binaries</h4><p>A system binary is typically modified by patching the entry function so that it jumps to the malicious code. The patch overwrites the very beginning of the function or some other code that is not required for the trojanized DLL to operate properly. The malicious code is added to an empty section of the binary, so that it will not impact normal operation. After the code loads the malware, it jumps back to the original DLL code.</p><h4 id=dll-load-order-hijacking>DLL Load-Order Hijacking</h4><p>This technique aims to place malicious DLLs before legitimate DLLs just by using the OS DLL load design. For the sake of example, if the legitimate DLL is not included in <code>KnownDLLs</code>, any binary that loads it will try to check the current working directory before <em>/System32</em>. This means that if a malicious DLL is placed on the CWD, it will have preference before the legitimate one.</p><h3 id=privilege-escalation>Privilege Escalation</h3><p>Processes run by a user donâ€™t have free access to everything, and canâ€™t, for instance, call functions like <em>TerminateProcess</em> or <em>CreateRemoteThread</em> on remote processes. <strong>One way that malware gains access to such functions is by setting the access tokenâ€™s rights to enable <em>SeDebugPrivilege</em></strong>. Granting <em>SeDebugPrivilege</em> to anyone is essentially equivalent to giving them LocalSystem account access.</p><p>The access token is obtained using a call to <em>OpenProcessToken</em>. It follows a call to <em>LookupPrivilegeValueA</em>. Then, <em>AdjustTokenPrivileges</em> is called.</p><h3 id=covering-its-tracksuser-mode-rootkits>Covering Its Tracksâ€”User-Mode Rootkits</h3><h4 id=iat-hooking>IAT Hooking</h4><figure><img src=../11.PNG></figure><h4 id=inline-hooking>Inline Hooking</h4><p>Inline hooking overwrites the API function code contained in the imported DLLs, so it must wait until the DLL is loaded to begin executing. <strong>IAT hooking simply modifies the pointers, but inline hooking changes the actual function code.</strong></p><h2 id=labs>Labs</h2><h3 id=lab-1>Lab 1</h3><p><strong>1. What does the malware drop to disk?</strong></p><p>In the following picture we can observe the imports and strings. Something that stands out is the call to msgina32.dll and the path <code>HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon\GinaDLL</code>. It can be an indicator that we are dealing with GINA interception.</p><figure><img src=../11-1-1.PNG></figure><p>Concerning basic dynamic analysis, we have detected that the malware creates and writes content to a file called <em>msgina32.dll</em>, located in the same directory where the sample is located.<figure><img src=../11-1-2.png></figure></p><p><strong>2. How does the malware achieve persistence?</strong></p><p>The malware achieves persistence through the Windows Registry. It adds a new value to <code>HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon\GinaDLL</code>.<figure><img src=../11-1-3.PNG></figure></p><p><strong>3. How does the malware steal user credentials?</strong></p><p><em>msgina32.dll</em> calls to the real functions in <em>msgina.dll</em> unless <code>WlxLoggedOutSAS</code> which passes the credential information to the legitimate DLL but at the same time takes the information and calls another function labeled as <em>Log_to_file</em>, which contains the name of file in charge of storing the data, <em>msutil32.sys</em>.</p><table><thead><tr><th style=text-align:center>WlxLoggedOutSAS</th><th style=text-align:center>Log_to_file</th></tr></thead><tbody><tr><td style=text-align:center><figure><img src=../11-1-4.PNG></figure></td><td style=text-align:center><figure><img src=../11-1-5.PNG></figure></td></tr></tbody></table><p><strong>4. What does the malware do with stolen credentials?</strong></p><p>All successful user logons are logged to <code>%SystemRoot%\system32\msutil32.sys</code>. The log includes the username, domain and password.</p><p><strong>5. How can you use this malware to get user credentials from your test environment?</strong></p><p>After rebooting the machine and login again, you can observe that the <em>msutil32.sys</em> file has logged your credentials.<figure><img src=../11-1-6.PNG></figure></p><h3 id=lab-2>Lab 2</h3><p><strong>1. What are the exports for this DLL malware?</strong></p><p>With PE Viewer we can observe the exports for the DLL. It contains only one export function called &ldquo;<em>installer</em>&rdquo;.<figure><img src=../11-2-1.PNG></figure></p><p><strong>2. What happens after you attempt to install this malware using rundll32.exe?</strong></p><p>When we run the following command <code>C:\>rundll32.exe Lab11-02.dll, installer</code> we do not observe too much activity. However, if we take a look at the ouput of Regshot, we observe the following thing:<figure><img src=../11-2-2.PNG></figure></p><p>If we recall the Persistence mechanisms that were mentioned in the Notes of this Chapter, AppInit_DLLs was one of them. The DLL that is loaded is present when looking at the strings of the DLL.<figure><img src=../11-2-3.PNG></figure></p><p><strong>3. Where must Lab11-02.ini reside in order for the malware to install properly?</strong></p><p>The .ini file must be located at <code>C:\Windows\System32</code>.<figure><img src=../11-2-4.PNG></figure></p><p><strong>4. How is this malware installed for persistence?</strong></p><p>As it was mentioned before: &ldquo;<em>AppInit_DLLs are loaded into every process that loads User32.dll, and a simple insertion into the registry will make AppInit_DLLs persistent.</em>&rdquo;
It copies itself to the file spooolvxx32.dll, located in <code>C:\Windows\System32</code>.<figure><img src=../11-2-5.PNG></figure></p><p><strong>5. What user-space rootkit technique does this malware employ?</strong></p><p>It attacks to wsock32.dll, particularly the <em>send</em> function.<figure><img src=../11-2-6.PNG></figure></p><p><strong>6. What does the hooking code do?</strong></p><p>It checks if the email is an outbound email and adds another recipient after loading it from <em>Lab11-02.ini</em>.</p><p><strong>7. Which process(es) does this malware attack and why?</strong></p><p>It attacks <em>thebat.exe</em>, <em>outlook.exe</em> and <em>msimn.exe</em>. These processes are related to the Microsoft Windows email application.<figure><img src=../11-2-7.PNG></figure></p><p><strong>8. What is the significance of the .ini file?</strong></p><p>The .ini file contains the encoded email account. If we debug <em>spooolvxx32.dll</em> file, and we set a breakpoint after the file has been read, we can observe that the EAX register contains the actual email address.<figure><img src=../11-2-8.PNG></figure></p><h3 id=lab-3>Lab 3</h3><p><strong>1. What interesting analysis leads can you discover using basic static analysis?</strong></p><p>In the following tables we can observe the strings and imports of the malware sample.</p><table><thead><tr><th style=text-align:center>Strings .exe file</th><th style=text-align:center>Imports .exe file</th></tr></thead><tbody><tr><td style=text-align:center><figure><img src=../11-3-1.PNG></figure></td><td style=text-align:center><figure><img src=../11-3-2.PNG></figure></td></tr></tbody></table><table><thead><tr><th style=text-align:center>Strings .dll file</th><th style=text-align:center>Imports .dll file</th></tr></thead><tbody><tr><td style=text-align:center><figure><img src=../11-3-3.PNG></figure></td><td style=text-align:center><figure><img src=../11-3-4.PNG></figure></td></tr></tbody></table><p>If we recall <em>Keystroke Logging</em> section, the DLL imports suspicious functions such as <em>GetAsyncKeyState</em> and <em>GetForegroundWindow</em>. This might be an indicator of a polling keylogger.</p><p><strong>2. What happens when you run this malware?</strong></p><p>The .exe file launches a command line window that says &ldquo;Content Indexing Service&rdquo;, but it is closed quickly.
The next image shows that the content from <em>Lab11-03.dll</em> is copied into <em>inet_epar32.dll</em>, which is located at <code>C:\Windows\System32</code>.<figure><img src=../11-3-5.PNG></figure></p><p>Regshot shows the different actions performed over the registry<figure><img src=../11-3-6.PNG></figure></p><p>Although the tools have not captured any activity linked to <em>kernel64x.dll</em> (it appeared in the strings of the DLL), if we inspect it, we can observe how it tracks the activity of the user.<figure><img src=../11-3-7.PNG></figure></p><p><strong>3. How does Lab11-03.exe persistently install Lab11-03.dll?</strong></p><p>It trojanizes the indexing service by changing the entry-point. It redirects the execution to run
shellcode, which loads the DLL.</p><p><strong>4. Which Windows system file does the malware infect?</strong></p><p>The cisvc.exe file.</p><p><strong>5. What does Lab11-03.dll do?</strong></p><p>It is a polling keylogger.</p><p><strong>6. Where does the malware store the data it collects?</strong></p><p>It stores the data at the <em>kernel64x.dll</em> file.</p></section><div class=post-tags><nav class="nav tags"><h2 class=title>Tags</h2><ul class=tags><li><a href=/tags/practical-malware-analysis>practical malware analysis</a></li><li><a href=/tags/malware>malware</a></li><li><a href=/tags/reversing>reversing</a></li><li><a href=/tags/advanced>advanced</a></li><li><a href=/tags/static>static</a></li><li><a href=/tags/dynamic>dynamic</a></li><li><a href=/tags/analysis>analysis</a></li><li><a href=/tags/x86>x86</a></li><li><a href=/tags/assembly>assembly</a></li><li><a href=/tags/registers>registers</a></li><li><a href=/tags/ollybg>ollybg</a></li><li><a href=/tags/ghidra>ghidra</a></li></ul></nav></div></article></main><footer><div style=display:flex><a class=soc href=https://github.com/pabdj title=GitHub><i data-feather=github></i></a>
<a class=border></a><a class=soc href=https://twitter.com/pabdjf title=Twitter><i data-feather=twitter></i></a>
<a class=border></a><a class=soc href=https://es.linkedin.com/in/pablodejuanfidalgo title=LinkedIn><i data-feather=linkedin></i></a>
<a class=border></a></div><div class=footer-info>2023 Â© Pablo de Juan Fidalgo |</div></footer><script>feather.replace()</script></div></body></html>